@page "/"
@attribute [Authorize(Roles = "Reader")]
@implements IBrowserViewportObserver

@using Microsoft.AspNetCore.Authorization
@using MudBlazor
@using RecettesFamille.Components.Pages.RecetteBook.Components
@using RecettesFamille.Data.Repository.IRepositories
@using RecettesFamille.Dto.ModelByPage.RecetteBook
@using RecettesFamille.Extensions

@inject IRecipeRepository RecipeRepository
@inject IBrowserViewportService BrowserViewportService


<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-3">

	<!-- Dernières recettes -->
	<MudStack Row="true" Class="mt-0 mb-0">
		<MudText Typo="Typo.h5" Style="font-weight:900;">@carouselTitle</MudText>
		<MudSpacer />
		<MudIconButton Icon="@Icons.Material.Filled.ArrowBackIosNew" Variant="Variant.Text" Color="Color.Primary" Size="Size.Medium" OnClick="@(() => mudCarousel.Previous())" />
		<MudIconButton Icon="@Icons.Material.Filled.ArrowForwardIos" Variant="Variant.Text" Color="Color.Primary" Size="Size.Medium" OnClick="@(() => mudCarousel.Next())" />
	</MudStack>

	@if (RecipeGroups != null && RecipeGroups.Any())
	{
		<MudCarousel @ref="mudCarousel" TData="RecipeForListDto" Class="mud-width-full pa-0 ma-0 mb-0" Style="min-height:440px;" AutoCycle="false"
					 ShowBullets="false" ShowArrows="false" EnableSwipeGesture="false">
			@foreach (var group in RecipeGroups)
			{
				<MudCarouselItem Class="pa-0 ma-0">
					<MudGrid Class="" Justify="Justify.Center" Style="height:100%;">
						@foreach (var recipe in group)
						{
							<MudItem xs="@xsItemSize">
								<RecipeCard Recipes="@recipe" />
							</MudItem>
						}
					</MudGrid>
				</MudCarouselItem>
			}
		</MudCarousel>
	}
	else
	{
		<MudText Typo="Typo.h6">Aucune recette trouvée.</MudText>
	}

	<MudStack Class="mt-0 mb-6">
		<RecipeListPage />
	</MudStack>

</MudContainer>

@code {
	MudCarousel<RecipeForListDto> mudCarousel { get; set; } = default!;
	List<RecipeForListDto> Recipes { get; set; } = null!;
	List<List<RecipeForListDto>> RecipeGroups { get; set; } = new();

	int groupSize = 4;
	int xsItemSize = 3;
	string carouselTitle = string.Empty;

	protected override void OnInitialized()
	{
		carouselTitle = Messages.GetRandomLatestRecipeTitles();
	}

	protected override async Task OnParametersSetAsync()
	{
		var result = await RecipeRepository.GetAllLightRecipe();
		Recipes = result.OrderBy(c => c.Name).ToList();

		var breakpoint = await BrowserViewportService.GetCurrentBreakpointAsync();
		if (breakpoint <= Breakpoint.Sm)
		{
			groupSize = 2;
			xsItemSize = 6;
		}

		RecipeGroups = GroupRecipes(Recipes.OrderByDescending(c => c.CreatedDate).Take(12).ToList(), groupSize);
	}

	private List<List<RecipeForListDto>> GroupRecipes(List<RecipeForListDto> recipes, int groupSize)
	{
		var result = new List<List<RecipeForListDto>>();

		for (int i = 0; i < recipes.Count; i += groupSize)
		{
			result.Add(recipes.Skip(i).Take(groupSize).ToList());
		}

		return result;
	}

	public Guid Id => throw new NotImplementedException();
	public Task NotifyBrowserViewportChangeAsync(BrowserViewportEventArgs browserViewportEventArgs)
	{
		return Task.CompletedTask;
	}
}