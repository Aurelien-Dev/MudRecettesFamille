@page "/recette/{IdRecette:int?}"
@using RecettesFamille.Components.Pages.RecetteBook.BlockDefinitions
@using RecettesFamille.Data
@using RecettesFamille.Data.EntityModel
@using RecettesFamille.Data.EntityModel.Blocks
@using RecettesFamille.Data.Repository.IRepositories
@using RecettesFamille.Dto.Models
@using RecettesFamille.Dto.Models.Blocks
@using RecettesFamille.Extensions
@using RecettesFamille.Managers;
@using RecettesFamille.Managers.AiGenerators

@if (Recette is not null)
{
    @if (editorMode)
    {
        <MudTextField @bind-Value="Recette.Name" Typo="Typo.h3" Style="font-weight: bold;" FullWidth="false" class="text-end" OnBlur="UpdateGeneralRecipeInformation" />
        <MudTextField @bind-Value="Recette.InformationPreparation" Typo="Typo.subtitle1" FullWidth="false" class="text-end" OnBlur="UpdateGeneralRecipeInformation" />
    }
    else
    {
        <MudText Typo="Typo.h3" Style="font-weight: bold;" Align="Align.Center" GutterBottom="true">@Recette.Name</MudText>
        <MudText Typo="Typo.subtitle1" Align="Align.Center" GutterBottom="true">@Recette.InformationPreparation</MudText>
    }

    <MudToolBar Class="justify-center mt-0 mb-0">
        <MudToggleIconButton @bind-Toggled="editorMode" Icon="@Icons.Material.Outlined.Edit"
        ToggledIcon="@Icons.Material.Filled.Edit" ToggledColor="@Color.Error" />
        <MudIconButton Icon="@Icons.Material.Outlined.DeleteForever" OnClick="DeleteRecipe" />
    </MudToolBar>

    @* Description recette *@
    <MudGrid Spacing="5" Class="mt-0 mb-12">
        @foreach (var block in Recette.BlocksInstructions.OrderBy(c => c.Order).EmptyIfNull())
        {
            <BaseBlock EditMode="editorMode" Block="block"
            OnBlockUpdated="OnBlockUpdated"
            OnBlockDeleted="OnBlockDeleted"
            OnBlockHasChanged="OnBlockHasChanged"
            MoveUp="MoveUp"
            MoveDown="MoveDown" />
        }

        @if (editorMode)
        {
            <ToolsComponent PrecedentIndex="@(Recette.BlocksInstructions.Count -1)" AddBlockCallback="AddNewBlock" />
        }
    </MudGrid>
}

<style>
    .text-end input {
    text-align: center !important;
    }
</style>

@code {
    [Inject] IRecetteRepository RecetteRepository { get; set; } = default!;
    [Inject] IDialogService dialogService { get; set; } = null!;
    [Inject] NavigationManager navigationManager { get; set; } = null!;

    [Parameter] public int IdRecette { get; set; }

    RecipeDto? Recette { get; set; } = null!;
    public bool editorMode { get; set; } = false;

    protected async override Task OnParametersSetAsync()
    {
        Recette = await RecetteRepository.GetWithInstructions(IdRecette);
    }

    public async Task DeleteRecipe()
    {
        bool? result = await dialogService.ShowMessageBox("Warning", "Deleting can not be undone!", yesText: "Delete!", cancelText: "Cancel");

        if (result is null || (result.HasValue && !result.Value))
            return;

        if (Recette is null)
            return;

        await RecetteRepository.DeleteRecipe(IdRecette);

        navigationManager.NavigateTo("/");
    }

    private async Task UpdateGeneralRecipeInformation()
    {
        if (Recette is null)
            return;

        await RecetteRepository.UpdateRecipe(Recette);

        StateHasChanged();
    }

    #region Block edition
    private Task OnBlockHasChanged()
    {
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task OnBlockDeleted(BlockBaseDto block)
    {
        bool success = await RecetteRepository.DeleteBlock(block.Id!.Value);

        if (!success) return;

        Recette!.BlocksInstructions.Remove(block);
        StateHasChanged();
    }

    private async Task OnBlockUpdated(BlockBaseDto block)
    {
        DbContext.Update(block);
        await DbContext.SaveChangesAsync();
        StateHasChanged();
    }

    private async Task AddNewBlock(BlockBaseDto block)
    {
        if (Recette is null)
            return;

        Recette.BlocksInstructions.Add(block);

        DbContext.Update(Recette);
        await DbContext.SaveChangesAsync();

        StateHasChanged();
    }
    #endregion

    #region Block move
    private async Task MoveUp(BlockBaseDto block)
    {
        if (Recette is null)
            return;

        Recette.BlocksInstructions.MoveUp(block);
        await DbContext.SaveChangesAsync();
        StateHasChanged();
    }

    private async Task MoveDown(BlockBaseDto block)
    {
        if (Recette is null)
            return;


        Recette.BlocksInstructions.MoveDown(block);
        await DbContext.SaveChangesAsync();
        StateHasChanged();
    }

    private async Task UpdateOrder()
    {
        if (Recette is null)
            return;

        await DbContext.SaveChangesAsync();
        StateHasChanged();
    }
    #endregion
}