@page "/recette"
@rendermode InteractiveServer
@using Newtonsoft.Json
@using RecettesFamille.Components.RecetteBook.BlockDefinitions
@using RecettesFamille.Data.DtoModelInovate
@using RecettesFamille.Managers
@using System.Text.Json
@using System.Text.Json.Serialization.Metadata

@if (Recette is not null)
{
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">@Recette.Name</MudText>
    <MudText Typo="Typo.subtitle1" Align="Align.Center" GutterBottom="true">@Recette.InformationPreparation</MudText>

    @* Description recette *@
    <MudGrid Spacing="5" Class="mt-10">
        @foreach (var block in Recette.BlocksInstructions.OrderBy(o => o.Order))
        {
            @switch (block)
            {
                case BlockInstruction instructionBlock:
                    <MudItem xs="12">
                        <InstructionComponent Block="instructionBlock" />
                    </MudItem>
                    break;
                case BlockIngredientList ingredientListBlock:
                    <MudItem xs="6">
                        <IngredientComponent Block="ingredientListBlock" />
                    </MudItem>
                    break;
                case BlockImage imageBlock:
                    <MudItem xs="6">
                        <ImageComponent Block="imageBlock" />
                    </MudItem>
                    break;

                // Ajoutez d'autres cas pour différents types de blocs ici
                default:
                    <MudItem xs="12">
                        <p>Type de bloc non pris en charge</p>
                    </MudItem>
                    break;
            }

            <MudItem xs="12">
                <ToolsComponent AddBlockCallback="AddNewBlock" PrecedentIndex="@block.Order" />
            </MudItem>
        }
    </MudGrid>
}
else
{
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GetRecipe">Chargement...</MudButton>
    <MudSkeleton SkeletonType="SkeletonType.Text" Width="100%" Height="100px" />
}


@code {
    [Inject] GptRecipeConverterManager gptRecipeConverterManager { get; set; } = null!;

    RecetteDto Recette { get; set; } = null!;

    protected async override Task OnInitializedAsync()
    {
    }

    public async Task GetRecipe()
    {
        JsonSerializerSettings withTypes = new JsonSerializerSettings
            {
                TypeNameHandling = TypeNameHandling.Auto
            };

        var serialized = JsonConvert.SerializeObject(SampleData.GetSampleRecettes(), withTypes);
        
        (RecetteDto recette, decimal cost) = await gptRecipeConverterManager.GenerateDescription();
        Recette = recette;
    }

    private void AddNewBlock(BlockBase block)
    {
        // Réordonner les items de BlocksInstructions
        foreach (var item in Recette.BlocksInstructions.OrderBy(o => o.Order))
        {
            if (item.Order >= block.Order)
            {
                item.Order++;
            }
        }

        Recette.BlocksInstructions.Add(block);
        StateHasChanged();
    }
}